<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>群組管理</title>

<style>
:root{
  --bg:#6c6c6c;
  --card:#ffffff;
  --primary:#002b88;
  --primary-light:#3b82f6;
  --danger:#ef4444;
  --muted:#6b7280;
  --shadow:0 6px 18px rgba(15,23,42,0.08);
  --radius:12px;
  font-family:-apple-system, BlinkMacSystemFont,'Segoe UI', Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;
}

html,body{ height:100%; margin:0; background:var(--bg); }
body{ padding:24px; display:flex; justify-content:center; }

.card{ width:100%; max-width:1300px; background:var(--card); border-radius:0; box-shadow:var(--shadow); overflow:hidden; margin-top:20px; }

.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 20px; background:var(--primary); color:white; }
.title{ font-size:20px; font-weight:600; }
.actions{ display:flex; gap:8px; align-items:center; }

.btn{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; }
.btn-primary{ background:var(--primary-light); color:white; }
.btn-danger{ background:var(--danger); color:white; }
.btn-close{
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #ccc;
    background:#ffffff;
    color:#374151;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
}

.list{ width:100%; border-top:1px solid #eee; border-bottom:1px solid #eee; margin-top:0; max-height:400px; overflow:auto; }
.list-head{ display:flex; gap:12px; padding:10px 8px; align-items:center; color:var(--muted); font-weight:700; background:#f9fafb; }
.list-row{ display:flex; align-items:center; gap:12px; padding:12px 8px; border-bottom:1px solid #f2f2f2; }

.col-1{ width:60px; flex-shrink:0; text-align:center; color:var(--muted); }
.col-2,.col-3{ flex:1; min-width:120px; }
.col-4,.col-5,.col-6{ width:90px; flex-shrink:0; text-align:center; }

.icon-btn{ padding:6px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; cursor:pointer; font-weight:600; }

.empty{ padding:28px; text-align:center; color:var(--muted); }

.search-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  background: #f9fafb;
  border-radius: 8px;
  margin: 0 16px 12px 16px;
  flex-wrap: nowrap;
}

.search-row .form-group{
  display: flex;
  align-items: center;
  gap: 4px;
}

.search-row .form-group label{
  font-size: 15px;
  font-weight: 500;
  color: var(--muted);
  white-space: nowrap;
  line-height: 32px;
}

.search-row .form-group input[type="text"]{
  width: 160px;
  height: 32px;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
  box-sizing: border-box;
}

.search-row select{
  width:80px;
  height:32px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:14px;
  padding:2px 6px;
}

.btn-search{
  height: 32px;
  padding: 0 14px;
  border-radius: 6px;
  background: var(--primary-light);
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pagination{ display:flex; gap:4px; flex-wrap:wrap; }
.pagination span{ cursor:pointer; padding:3px 5px; color:var(--primary); font-weight:600; font-size:12px; }
.pagination span.current{ font-weight:700; text-decoration:underline; cursor:default; color:#111; }
.pagination span.disabled{ color:#999; cursor:default; }
.pagination-container{ display:flex; justify-content:center; padding:8px 0; }

.modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,0.45); display:flex; align-items:center; justify-content:center; z-index:100; }
.modal{ background:var(--card); border-radius:var(--radius); padding:0; max-width:560px; width:92%; box-shadow:var(--shadow); overflow:hidden; }
.modal-header{ padding:16px 20px; background:var(--primary); color:white; font-size:18px; font-weight:600; }
.modal-body{ padding:18px; }

.form-row{ display:flex; align-items:center; gap:8px; margin-bottom:12px; justify-content:flex-start; }
.form-row label{ width:90px; font-size:16px; color:var(--muted); text-align:left; }
.form-row input[type="text"], .form-row select{ flex:1; padding:6px 8px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
.form-row input[type="text"]:focus, .form-row select:focus{ border-color:var(--primary-light); box-shadow:0 0 4px rgba(59,130,246,0.4); }

.modal-footer{ display:flex; gap:8px; justify-content:flex-end; padding:12px 18px; background:#f9fafb; }

.added-sites{ border-top:1px solid #eee; margin-top:6px; padding-top:6px; }
.site-list{ display:flex; flex-direction:column; gap:4px; }
.site-item{ display:flex; align-items:center; justify-content:space-between; background:#f1f5f9; padding:4px 8px; border-radius:4px; }
.site-item button{ border:none; background:none; cursor:pointer; font-weight:bold; color:var(--danger); }

#topBtn{ position:fixed; right:20px; bottom:20px; width:40px; height:40px; background:var(--primary-light); color:white; border:none; border-radius:6px; display:none; align-items:center; justify-content:center; cursor:pointer; z-index:200; }
#topBtn:hover{ background:#0056b3; }
</style>
</head>
<body>

<div class="card">
  <div class="header">
    <div class="title">群組管理</div>
    <div class="actions">
      <button id="addBtn" class="btn btn-primary" onclick="openModal()">＋ 新增群組</button>
    </div>
  </div>

  <!-- 搜尋列 -->
  <div class="search-row" role="search" aria-label="搜尋群組">
    <div class="form-group">
      <label for="searchName">群組名稱</label>
      <input id="searchName" type="text" placeholder="輸入群組名稱" />
    </div>
    <div class="form-group"><label>每頁筆數</label>
    <select id="pageSizeSelect" onchange="changePageSize()">
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="75">75</option>
      <option value="100">100</option>
    </select>
    </div>
    <button class="btn-search" onclick="searchGroup()">搜尋</button>
  </div>

  <!-- 頁碼與總筆數（右上） -->
  <div style="display:flex; justify-content:space-between; padding:0 20px; align-items:center;">
    <div id="countText" style="color:var(--muted)">共 0 筆資料</div>
    <div id="topPagination" class="pagination"></div>
  </div>

  <!-- 列表 -->
  <div class="list" aria-live="polite">
    <div class="list-head">
      <div class="col-1">序號</div>
      <div class="col-2">群組名稱</div>
      <div class="col-3">備註</div>
      <div class="col-4">編輯</div>
      <div class="col-5">刪除</div>
      <div class="col-6">瀏覽</div>
    </div>
    <div id="rowsContainer">
      <div class="empty">目前沒有群組資料</div>
    </div>
  </div>

  <!-- 頁碼（底部） -->
  <div id="bottomPagination" class="pagination-container">
    <div class="pagination"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" style="display:none">
  <div class="modal-backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header" id="modalTitle">新增群組</div>
      <div class="modal-body">
        <div class="form-row">
          <label for="inputName">群組名稱</label>
          <input id="inputName" type="text" placeholder="輸入群組名稱" />
        </div>
        <div class="form-row">
          <label for="inputRemark">備註</label>
          <input id="inputRemark" type="text" placeholder="輸入備註" />
        </div>

        <div class="form-row" style="gap:8px;">
          <select id="siteSelect">
            <option value="">選擇案場</option>
            <option value="SiteA">Site A</option>
            <option value="SiteB">Site B</option>
            <option value="SiteC">Site C</option>
          </select>
          <button class="btn btn-primary" onclick="addSite()">加入群組</button>
        </div>

        <div class="added-sites">
          <div class="site-list" id="addedSites"></div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-close" id="cancelBtn">取消</button>
        <button class="btn btn-primary" id="saveBtn">確認</button>
      </div>
    </div>
  </div>
</div>

<button id="topBtn" onclick="scrollToTop()">TOP</button>

<script>
// ================= DATA & MODAL =================
let groups = [];
let editingId = null;
let currentPage = 1;
let pageSize = 25;
let filteredGroups = [];

const rowsContainer = document.getElementById('rowsContainer');
const countText = document.getElementById('countText');
const modal = document.getElementById('modal');
const backdrop = document.getElementById('backdrop');
const inputName = document.getElementById('inputName');
const inputRemark = document.getElementById('inputRemark');
const siteSelect = document.getElementById('siteSelect');
const addedSitesDiv = document.getElementById('addedSites');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');
const pageSizeSelect = document.getElementById('pageSizeSelect');
const topPagination = document.getElementById('topPagination');
const bottomPagination = document.querySelector('#bottomPagination .pagination');

// ---------------- MODAL ----------------
function openModal(){
  editingId = null;
  inputName.value = '';
  inputRemark.value = '';
  siteSelect.value = '';
  addedSitesDiv.innerHTML = '';
  modal.style.display = 'block';
  document.getElementById('modalTitle').textContent = '新增群組';
  restoreModalEditable();
}
function closeModal(){ modal.style.display = 'none'; restoreModalEditable(); }

backdrop.addEventListener('click', e => { if(e.target === backdrop) closeModal(); });
cancelBtn.addEventListener('click', closeModal);

function addSite(){
  const val = (siteSelect.value || '').trim();
  if(!val) return;
  const exists = Array.from(addedSitesDiv.querySelectorAll('.site-item span')).some(s => s.textContent === val);
  if(exists) return;
  const div = document.createElement('div'); div.className = 'site-item';
  div.innerHTML = `<span>${escapeHtml(val)}</span><button class="btn btn-danger" onclick="this.parentNode.remove()">×</button>`;
  addedSitesDiv.appendChild(div);
  siteSelect.value = '';
}

function saveGroup(){
  const name = inputName.value.trim();
  const remark = inputRemark.value.trim();
  if(!name){ alert('群組名稱必填'); return; }
  const joins = Array.from(addedSitesDiv.querySelectorAll('.site-item span')).map(s => s.textContent);

  if(editingId !== null){
    groups[editingId] = { name, remark, sites: joins };
  } else {
    groups.push({ name, remark, sites: joins });
  }
  closeModal();
  searchGroup();
}
saveBtn.addEventListener('click', saveGroup);

function openEdit(idx){
  const g = filteredGroups[idx];
  if(!g) return;
  editingId = groups.indexOf(g);
  inputName.value = g.name;
  inputRemark.value = g.remark || '';
  addedSitesDiv.innerHTML = '';
  (g.sites || []).forEach(s => {
    const div = document.createElement('div'); div.className = 'site-item';
    div.innerHTML = `<span>${escapeHtml(s)}</span><button class="btn btn-danger" onclick="this.parentNode.remove()">×</button>`;
    addedSitesDiv.appendChild(div);
  });
  document.getElementById('modalTitle').textContent = '編輯群組';
  modal.style.display = 'block';
  restoreModalEditable();
}

function deleteGroup(idx){
  const g = filteredGroups[idx];
  if(!g) return;
  if(!confirm('確定刪除此群組？')) return;
  groups.splice(groups.indexOf(g),1);
  searchGroup();
}

// ---------------- 瀏覽 ----------------
function viewDetail(idx){
  const g = filteredGroups[idx];
  if(!g) return;
  inputName.value = g.name;
  inputRemark.value = g.remark || '';
  addedSitesDiv.innerHTML = '';
  (g.sites || []).forEach(s => {
    const div = document.createElement('div'); 
    div.className = 'site-item';
    div.innerHTML = `<span>${escapeHtml(s)}</span>`;
    addedSitesDiv.appendChild(div);
  });
  document.getElementById('modalTitle').textContent = '群組瀏覽';
  inputName.disabled = true;
  inputRemark.disabled = true;
  siteSelect.disabled = true;
  saveBtn.style.display = 'none';
  const formRows = addedSitesDiv.parentNode.querySelectorAll('.form-row button, #siteSelect');
  formRows.forEach(el => el.style.display = 'none');
  modal.style.display = 'block';
}

function restoreModalEditable(){
  inputName.disabled = false;
  inputRemark.disabled = false;
  siteSelect.disabled = false;
  saveBtn.style.display = 'inline-block';
  const formRows = addedSitesDiv.parentNode.querySelectorAll('.form-row button, #siteSelect');
  formRows.forEach(el => el.style.display = 'inline-block');
}

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

// ---------------- 分頁 ----------------
function changePageSize(){
  pageSize = parseInt(pageSizeSelect.value);
  currentPage = 1;
  renderList();
}

function getPaginatedData(){
  const start = (currentPage-1)*pageSize;
  return filteredGroups.slice(start, start+pageSize);
}

function renderList(){
  rowsContainer.innerHTML = '';
  const data = getPaginatedData();
  if(data.length===0){
    rowsContainer.appendChild(Object.assign(document.createElement('div'), { className:'empty', textContent:'查無資料' }));
    countText.textContent = '共 0 筆資料';
    topPagination.innerHTML='';
    bottomPagination.innerHTML='';
    return;
  }
  countText.textContent = '共 '+filteredGroups.length+' 筆資料';
  data.forEach((g,idx)=>{
    const row = document.createElement('div'); row.className='list-row';
    row.innerHTML=`
      <div class="col-1">${(currentPage-1)*pageSize+idx+1}</div>
      <div class="col-2">${escapeHtml(g.name)}</div>
      <div class="col-3">${escapeHtml(g.remark||'')}</div>
      <div class="col-4"><button class="icon-btn" onclick="openEdit(${idx})">編輯</button></div>
      <div class="col-5"><button class="icon-btn" onclick="deleteGroup(${idx})">刪除</button></div>
      <div class="col-6"><button class="icon-btn" onclick="viewDetail(${idx})">瀏覽</button></div>
    `;
    rowsContainer.appendChild(row);
  });
  renderPagination();
}

// ---------------- 搜尋 ----------------
function searchGroup(){
  const sname = document.getElementById('searchName').value.trim().toLowerCase();
  filteredGroups = groups.filter(g => !sname || g.name.toLowerCase().includes(sname));
  currentPage=1;
  renderList();
}

// ---------------- 分頁 DOM ----------------
function renderPagination(){
  const totalPages = Math.ceil(filteredGroups.length/pageSize);
  if(totalPages<=0) { topPagination.innerHTML=''; bottomPagination.innerHTML=''; return; }

  function createPageHTML(page, text, current=false, disabled=false){
    const span = document.createElement('span');
    span.textContent = text;
    if(current) span.className='current';
    if(disabled) span.className='disabled';
    else span.addEventListener('click',()=>{ currentPage=page; renderList(); });
    return span;
  }

  // 頁碼陣列：右上、底部統一
  const pages = [];
  if(totalPages<=5){
    for(let i=1;i<=totalPages;i++) pages.push(i);
  } else {
    pages.push(1);
    let left = Math.max(2,currentPage-1);
    let right = Math.min(totalPages-1,currentPage+1);
    if(left>2) pages.push('...');
    for(let i=left;i<=right;i++) pages.push(i);
    if(right<totalPages-1) pages.push('...');
    pages.push(totalPages);
  }

  topPagination.innerHTML='';
  bottomPagination.innerHTML='';

  // 右上：第一頁 / 頁碼 / 最後一頁
  topPagination.appendChild(createPageHTML(1,'第一頁',false, currentPage===1));
  pages.forEach(p=>{
    if(p==='...'){ topPagination.appendChild(createPageHTML(null,'...','disabled')); }
    else topPagination.appendChild(createPageHTML(p,p,p===currentPage));
  });
  topPagination.appendChild(createPageHTML(totalPages,'最後一頁',false, currentPage===totalPages));

  // 底部：上一頁 / 頁碼 / 下一頁
  bottomPagination.appendChild(createPageHTML(Math.max(1,currentPage-1),'上一頁',false,currentPage===1));
  pages.forEach(p=>{
    if(p==='...'){ bottomPagination.appendChild(createPageHTML(null,'...','disabled')); }
    else bottomPagination.appendChild(createPageHTML(p,p,p===currentPage));
  });
  bottomPagination.appendChild(createPageHTML(Math.min(totalPages,currentPage+1),'下一頁',false,currentPage===totalPages));
}

// ---------------- 回頂部 ----------------
const topBtn = document.getElementById('topBtn');
window.addEventListener('scroll',()=>{ topBtn.style.display=(window.scrollY>100)?'flex':'none'; });
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

searchGroup();
</script>
</body>
</html>
