<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>權限管理</title>
<style>
:root{
  --bg:#6c6c6c;
  --card:#ffffff;
  --primary:#002b88;
  --primary-light:#3b82f6;
  --danger:#ef4444;
  --muted:#6b7280;
  --shadow:0 6px 18px rgba(15,23,42,0.08);
  --radius:12px;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC','Microsoft JhengHei',sans-serif;
}
html,body{height:100%;margin:0;background:var(--bg);}
body{padding:24px;display:flex;justify-content:center;}
.card{width:100%;max-width:1100px;background:var(--card);border-radius:0;box-shadow:var(--shadow);overflow:hidden;}
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--primary);color:#fff;}
.title{font-size:20px;font-weight:600;}
.actions{display:flex;gap:8px;}
.btn{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;}
.btn-primary{background:var(--primary-light);color:#fff;}
.btn-danger{background:var(--danger);color:#fff;}
.icon-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,.1);background:#fff;cursor:pointer;}
.list{border-top:1px solid #eee;border-bottom:1px solid #eee;}
.list-head,.list-row{display:flex;align-items:center;gap:12px;padding:10px 8px;}
.list-head{background:#f9fafb;font-weight:700;color:var(--muted);}
.list-row{border-bottom:1px solid #f2f2f2;}
.col-1{width:60px;text-align:center;color:var(--muted);}
.col-2{flex:1;min-width:160px;}
.col-3{flex:2;min-width:220px;}
.col-4,.col-5,.col-6{width:90px;text-align:center;}
.empty{padding:28px;text-align:center;color:var(--muted);}
#countText{padding:8px 20px;color:var(--muted);}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:flex;align-items:center;justify-content:center;z-index:100;}
.modal{background:#fff;border-radius:var(--radius);max-width:760px;width:94%;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow);}
.modal-body{padding:18px;overflow-y:auto;}
.modal-header{padding:16px 20px;background:var(--primary);color:#fff;font-size:18px;font-weight:600;}
.modal-footer{padding:12px 18px;background:#f9fafb;display:flex;gap:8px;justify-content:flex-end;}
.form-row{display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;}
.form-row label{width:90px;color:var(--muted);font-weight:500;}
.form-row input[type="text"]{flex:1;padding:6px 8px;border-radius:6px;border:1px solid #ccc;}
.permission-table-container{margin-top:16px;}
.permission-table{width:100%;border-collapse:collapse;}
.permission-table th,.permission-table td{border:1px solid #ddd;padding:6px;text-align:center;font-weight:400;}
.permission-table th{background:#f3f4f6;font-weight:600;}
.permission-name{text-align:left;padding-left:10px;}
.permission-parent-name{font-weight:700;}
.permission-child{padding-left:20px;text-align:left;}
.permission-radio input{margin:0;}
#topBtn{position:fixed;right:20px;bottom:20px;width:42px;height:42px;border-radius:8px;background:var(--primary-light);color:#fff;border:none;cursor:pointer;display:none;z-index:200;}
</style>
</head>
<body>

<div class="card">
  <div class="header">
    <div class="title">群組管理</div>
    <div class="actions">
      <button class="btn btn-primary" onclick="openModal()">＋ 新增群組</button>
    </div>
  </div>

  <div class="list">
    <div class="list-head">
      <div class="col-1">序號</div>
      <div class="col-2">群組名稱</div>
      <div class="col-3">群組說明</div>
      <div class="col-4">編輯</div>
      <div class="col-5">刪除</div>
      <div class="col-6">瀏覽</div>
    </div>
    <div id="rowsContainer">
      <div class="empty">目前沒有群組資料</div>
    </div>
  </div>
</div>

<!-- ================= Modal ================= -->
<div id="modal" style="display:none">
  <div class="modal-backdrop" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header" id="modalTitle">新增群組</div>
      <div class="modal-body">

        <div class="form-row">
          <label>群組名稱</label>
          <input id="permName" type="text" placeholder="輸入群組名稱" />
        </div>

        <div class="form-row">
          <label>群組說明</label>
          <input id="permDesc" type="text" placeholder="輸入說明" />
        </div>

        <div style="margin-top:16px;font-weight:500;color:var(--muted)">開放功能</div>
        <div class="permission-table-container">
          <table class="permission-table" id="permTable">
            <thead>
              <tr>
                <th>功能</th>
                <th>瀏覽</th>
                <th>編輯</th>
                <th>取消</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">取消</button>
        <button class="btn btn-primary" id="confirmBtn" onclick="savePermission()">確認</button>
      </div>
    </div>
  </div>
</div>

<button id="topBtn" onclick="scrollToTop()">TOP</button>

<script>
// ======= 權限資料 =======
let permissions = [];
let editingIndex = null;

// 父子功能定義
const features = [
  { name: "地震事件", children:["地震事件紀錄","DIO 發報紀錄"] },
  { name: "2U 主機管理", children:["2U 主機設定","2U主機群組管理","氣象署連線設定","地震發報設定"] },
  { name: "狀態管理", children:["連線狀態","管理紀錄"] },
  { name: "模擬演練", children:["地震模擬","地震模擬（群組）","地震模擬排程"] },
  { name: "文件下載", children:["文件下載"]  },
  { name: "後台設定", children:["後台群組管理","帳號管理","後台紀錄","變更密碼","登出"] }
];

// ======= 渲染列表 =======
const rowsContainer = document.getElementById('rowsContainer');
function render(){
  rowsContainer.innerHTML = '';
  if(permissions.length === 0){
    rowsContainer.innerHTML = '<div class="empty">目前沒有群組資料</div>';
    return;
  }
  permissions.forEach((p,i)=>{
    const row = document.createElement('div');
    row.className = 'list-row';
    row.innerHTML = `
      <div class="col-1">${i+1}</div>
      <div class="col-2">${p.name}</div>
      <div class="col-3">${p.desc}</div>
      <div class="col-4"><button class="icon-btn" onclick="editPerm(${i})">編輯</button></div>
      <div class="col-5"><button class="icon-btn" onclick="delPerm(${i})">刪除</button></div>
      <div class="col-6"><button class="icon-btn" onclick="viewPerm(${i})">瀏覽</button></div>
    `;
    rowsContainer.appendChild(row);
  });
}

// ======= 表格生成 =======
function generatePermTable(selected=[]){
  const tbody = document.querySelector("#permTable tbody");
  tbody.innerHTML = "";
  features.forEach((f,fi)=>{
    // 父功能列
    if(f.children){
      const trParent = document.createElement("tr");
      trParent.innerHTML = `<td class="permission-parent-name" colspan="4">${f.name}</td>`;
      tbody.appendChild(trParent);
      // 子功能列
      f.children.forEach((c,ci)=>{
        const idx = `${fi}_${ci}`;
        const sel = selected[idx] || "none";
        const tr = document.createElement("tr");
        tr.dataset.idx = idx;
        tr.innerHTML = `
          <td class="permission-child">${c}</td>
          <td class="permission-radio"><input type="radio" name="perm_${idx}" value="view" ${sel==="view"?"checked":""}></td>
          <td class="permission-radio"><input type="radio" name="perm_${idx}" value="edit" ${sel==="edit"?"checked":""}></td>
          <td class="permission-radio"><input type="radio" name="perm_${idx}" value="none" ${sel==="none"?"checked":""}></td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      const idx = `${fi}_0`;
      const sel = selected[idx] || "none";
      const tr = document.createElement("tr");
      tr.dataset.idx = idx;
      tr.innerHTML = `
        <td>${f.name}</td>
        <td class="permission-radio"><input type="radio" name="perm_${idx}" value="view" ${sel==="view"?"checked":""}></td>
        <td class="permission-radio"><input type="radio" name="perm_${idx}" value="edit" ${sel==="edit"?"checked":""}></td>
        <td class="permission-radio"><input type="radio" name="perm_${idx}" value="none" ${sel==="none"?"checked":""}></td>
      `;
      tbody.appendChild(tr);
    }
  });
}

// ======= Modal 控制 =======
function openModal(){
  editingIndex = null;
  document.getElementById('modalTitle').textContent = '新增群組';
  document.getElementById('permName').value='';
  document.getElementById('permDesc').value='';
  document.getElementById('permName').disabled=false;
  document.getElementById('permDesc').disabled=false;
  generatePermTable();
  document.getElementById('confirmBtn').style.display='inline-block';
  document.getElementById('modal').style.display='block';
}
function closeModal(e){ if(e && e.target!==e.currentTarget) return; document.getElementById('modal').style.display='none'; }

function savePermission(){
  const name = document.getElementById('permName').value.trim();
  const desc = document.getElementById('permDesc').value.trim();
  if(!name){ alert('請輸入群組名稱'); return; }

  const tbody = document.querySelector("#permTable tbody");
  const perms = {};
  tbody.querySelectorAll('tr').forEach(tr=>{
    if(tr.dataset.idx){
      const idx = tr.dataset.idx;
      const radios = document.getElementsByName(`perm_${idx}`);
      const val = Array.from(radios).find(r=>r.checked).value;
      perms[idx] = val;
    }
  });

  const data = { name, desc, perms };
  if(editingIndex!==null) permissions[editingIndex]=data;
  else permissions.push(data);

  closeModal();
  render();
}

function editPerm(i){
  const p = permissions[i];
  editingIndex = i;
  document.getElementById('modalTitle').textContent = '編輯群組';
  document.getElementById('permName').value = p.name;
  document.getElementById('permDesc').value = p.desc;
  document.getElementById('permName').disabled = false;
  document.getElementById('permDesc').disabled = false;
  generatePermTable(p.perms);
  document.getElementById('confirmBtn').style.display='inline-block';
  document.getElementById('modal').style.display='block';
}

function viewPerm(i){
  const p = permissions[i];
  document.getElementById('modalTitle').textContent = '權限瀏覽';
  document.getElementById('permName').value = p.name;
  document.getElementById('permDesc').value = p.desc;
  document.getElementById('permName').disabled = true;
  document.getElementById('permDesc').disabled = true;
  generatePermTable(p.perms);
  document.querySelectorAll("#permTable input").forEach(i=>i.disabled=true);
  document.getElementById('confirmBtn').style.display='none';
  document.getElementById('modal').style.display='block';
}

function delPerm(i){ if(confirm('確定刪除此群組？')){ permissions.splice(i,1); render(); } }

const topBtn = document.getElementById('topBtn');
window.addEventListener('scroll',()=>{ topBtn.style.display = window.scrollY>120?'block':'none'; });
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

render();
</script>
</body>
</html>
